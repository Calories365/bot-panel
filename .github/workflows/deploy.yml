name: Deploy bot-panel

on:
    push:
        branches: [ main ]

jobs:
    deploy:
        # работаем на своём сервере-раннере
        runs-on: self-hosted

        steps:
            # 1. Забираем свежий коммит репо в $GITHUB_WORKSPACE
            - name: Checkout repo
              uses: actions/checkout@v4

            -   name: Where am I?
                run: echo "$GITHUB_WORKSPACE" && pwd

            # 2. (необязательно) — отдельный git pull именно в src
            #    если у вас там доп-remote / submodule и т.п.
            - name: Pull src only
              working-directory: ${{ github.workspace }}/src
              run: git pull

            # 3. Собираем/обновляем контейнеры — команда выполняется из корня,
            #    где лежит docker-compose.yml
            - name: Build & restart stack
              working-directory: ${{ github.workspace }}
              run: |
                  export DOCKER_BUILDKIT=1
                  docker-compose up -d --build
                  docker builder prune --filter "until=168h" --force

            # 4. Запускаем миграции внутри PHP-контейнера
            - name: Run Laravel migrations
              working-directory: ${{ github.workspace }}
              run: docker-compose exec bot_panel_php php artisan migrate --force
