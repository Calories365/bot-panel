# .github/workflows/deploy.yml
name: Deploy bot-panel (host-runner)

on:
    push:
        branches: [main]

jobs:
    deploy:
        # рабочая машина — ваш self-hosted runner «maximserv»
        runs-on: self-hosted     # хватит дефолтного лейбла; при желании можно
        # указать runs-on: [self-hosted, Linux, X64]

        steps:
            # 1. синхронизируем прод-код с GitHub-ом
            - name: Git pull → /var/www/bot-panel/src
              run: |
                  cd /home/maxim/var/www/bot-panel/src
                  # надёжнее, чем просто `git pull`
                  git fetch origin main
                  git reset --hard origin/main

            # 2. пересобираем и перезапускаем стек
            - name: Docker compose up --build
              working-directory: /home/maxim/var/www/bot-panel
              run: |
                  export DOCKER_BUILDKIT=1
                  docker compose up -d --build
                  docker builder prune --filter "until=168h" --force

            # 3. миграции БД
            - name: Laravel migrate --force
              working-directory: /home/maxim/var/www/bot-panel
                # -T → не ждать stdin
              run: docker compose exec -T bot_panel_php php artisan migrate --force
