# .github/workflows/deploy.yml
name: Deploy bot-panel

on:
    push:
        branches: [main]

jobs:
    deploy:
        # работаем на своём self-hosted-раннере
        runs-on: self-hosted

        steps:
            # 1. Клонируем свежий коммит репозитория
            - name: Checkout repo
              uses: actions/checkout@v4

            # 2. Обновляем вложенный src (можно убрать, если не нужно)
            - name: git pull src
              working-directory: ${{ github.workspace }}/src
              run: git pull || true

            - name: Where am I?
              run: echo "$GITHUB_WORKSPACE" && pwd

            - name: Where am I2?
              working-directory: ${{ github.workspace }}/..
              run: echo "$GITHUB_WORKSPACE" && pwd



#            # 3. Собираем и перезапускаем весь стек
#            - name: Build & restart stack
#                # docker-compose.yml лежит на уровень выше, поэтому «..»
#              working-directory: ${{ github.workspace }}/..
#              run: |
#                  export DOCKER_BUILDKIT=1
#                  docker-compose up -d --build
#                  docker builder prune --filter "until=168h" --force
#
#            # 4. Прогоняем миграции Laravel внутри PHP-контейнера
#            - name: Run Laravel migrations
#              working-directory: ${{ github.workspace }}/..
#              run: docker-compose exec bot_panel_php php artisan migrate --force
